<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作任務追蹤器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0fafc;
        }

        .task-card {
            transition: box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
            cursor: grab;
        }

        .task-card:hover {
            box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.1);
        }
        
        .sortable-ghost {
            opacity: 0.4;
            background: #cce7ff;
        }
        
        .sortable-drag {
            cursor: grabbing;
        }
    </style>
</head>

<body class="p-4 sm:p-6 md:p-8">

    <div id="app-wrapper">
    
        <div id="login-container" class="max-w-md mx-auto mt-10 p-8 bg-white rounded-lg shadow-lg">
            <h1 class="text-2xl font-bold text-center mb-6">任務追蹤器登入</h1>
            <div class="space-y-4">
                <input type="email" id="email" placeholder="電子郵件" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="password" placeholder="密碼" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex gap-4">
                    <button id="register-btn" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition">註冊</button>
                    <button id="login-btn" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition">登入</button>
                </div>
                <div class="relative my-4">
                  <div class="absolute inset-0 flex items-center"><span class="w-full border-t"></span></div>
                  <div class="relative flex justify-center text-xs uppercase"><span class="bg-white px-2 text-gray-500">或</span></div>
                </div>
                <button id="google-login-btn" class="w-full flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-50 transition">
                    <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v8.51h12.8c-.57 3.32-2.31 6.16-4.89 8.08l7.45 5.73C44.97 38.92 48 32.17 48 24c0-.73-.07-1.44-.19-2.14z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.45-5.73c-2.15 1.45-4.92 2.3-8.44 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                    <span>使用 Google 帳號登入</span>
                </button>
            </div>
        </div>

        <div id="app-container" style="display: none;">
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">工作任務追蹤器</h1>
                <div>
                    <span id="user-info" class="text-gray-600 mr-4"></span>
                    <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">登出</button>
                </div>
            </header>

            <main>
                <div class="mb-6 flex gap-4">
                    <input type="text" id="new-task-title" placeholder="新增任務標題..." class="flex-grow px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <select id="new-task-priority" class="px-4 py-2 border rounded-lg">
                        <option value="3">高</option>
                        <option value="2" selected>中</option>
                        <option value="1">低</option>
                    </select>
                    <button id="add-task-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">新增</button>
                </div>
                
                <div id="task-columns" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    </div>
            </main>
        </div>

    </div>


    <script type="module">
        // =======================================================================
        // 1. 現代化的 Firebase SDK 引入 (使用 CDN 網址)
        // =======================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            doc,
            addDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            query,
            orderBy,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =======================================================================
        // 2. 您的 Firebase 專案設定
        // =======================================================================
        const firebaseConfig = {apiKey: "AIzaSyB8hi6fTfd3a8WdmqGkyhaMqsRHZ_WieSw",
  authDomain: "my-task-tracker-d86e7.firebaseapp.com",
  projectId: "my-task-tracker-d86e7",
  storageBucket: "my-task-tracker-d86e7.appspot.com",
  messagingSenderId: "609459385303",
  appId: "1:609459385303:web:b712c974e810e427b21192",
  measurementId: "G-5EXGN1NF59"};

        // =======================================================================
        // 3. 初始化 Firebase App 和所有需要的服務
        // =======================================================================
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // =======================================================================
        // 4. 應用程式狀態與常數 (整合自您原有的程式碼)
        // =======================================================================
        const STATUSES = {
            TODO: { text: "待辦事項", color: "bg-gray-200" },
            HOLD: { text: "暫緩中", color: "bg-yellow-200" },
            COMPLETED: { text: "已完成", color: "bg-green-200" },
            DELETED: { text: "已刪除", color: "bg-red-200" }
        };
        const PRIORITIES = { 1: "低", 2: "中", 3: "高" };
        
        let state = {
            currentUser: null,
            tasks: [],
            unsubscribeTasks: null // 用來存放取消監聽的函數
        };
        
        // =======================================================================
        // 5. DOM 元素獲取
        // =======================================================================
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const registerBtn = document.getElementById('register-btn');
        const loginBtn = document.getElementById('login-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const taskColumnsContainer = document.getElementById('task-columns');
        const addTaskBtn = document.getElementById('add-task-btn');
        const newTaskTitleInput = document.getElementById('new-task-title');
        const newTaskPrioritySelect = document.getElementById('new-task-priority');

        // =======================================================================
        // 6. 核心功能：認證 (Authentication)
        // =======================================================================

        // Email/密碼 註冊
        registerBtn.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            createUserWithEmailAndPassword(auth, email, password)
                .then(cred => alert('註冊成功！'))
                .catch(err => alert('註冊失敗：' + err.message));
        });

        // Email/密碼 登入
        loginBtn.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(err => alert('登入失敗：' + err.message));
        });

        // Google 登入
        googleLoginBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .catch(err => alert('Google 登入失敗：' + err.message));
        });

        // 登出
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // 監聽認證狀態變化 (這是整個應用的樞紐)
        onAuthStateChanged(auth, user => {
            if (user) {
                // 使用者已登入
                state.currentUser = user;
                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';
                userInfo.textContent = `歡迎, ${user.displayName || user.email}`;
                
                // 開始監聽屬於這位使用者的任務
                fetchTasks();

            } else {
                // 使用者已登出
                state.currentUser = null;
                loginContainer.style.display = 'block';
                appContainer.style.display = 'none';
                userInfo.textContent = '';
                
                // 如果有在監聽，取消它
                if (state.unsubscribeTasks) {
                    state.unsubscribeTasks();
                }
                // 清空畫面
                state.tasks = [];
                render();
            }
        });

        // =======================================================================
        // 7. 核心功能：資料庫 (Firestore) 操作
        // =======================================================================
        
        // 獲取並監聽任務
        function fetchTasks() {
            if (!state.currentUser) return;
            
            // 如果已經有監聽，先取消舊的
            if (state.unsubscribeTasks) state.unsubscribeTasks();

            const userId = state.currentUser.uid;
            const tasksCollectionRef = collection(db, 'users', userId, 'tasks');
            const q = query(tasksCollectionRef, orderBy('createdAt', 'desc'));

            state.unsubscribeTasks = onSnapshot(q, (snapshot) => {
                state.tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render(); // 每次資料更新時，重新渲染整個畫面
            }, (error) => {
                console.error("監聽任務失敗:", error);
            });
        }

        // 新增任務
        addTaskBtn.addEventListener('click', () => {
            const title = newTaskTitleInput.value.trim();
            const priority = parseInt(newTaskPrioritySelect.value);
            if (!title || !state.currentUser) return;

            const userId = state.currentUser.uid;
            const tasksCollectionRef = collection(db, 'users', userId, 'tasks');
            
            addDoc(tasksCollectionRef, {
                title: title,
                status: 'TODO',
                priority: priority,
                createdAt: serverTimestamp()
            }).then(() => {
                newTaskTitleInput.value = ''; // 清空輸入框
            }).catch(err => console.error("新增任務失敗:", err));
        });

        // 更新任務 (通常用於拖曳後更新狀態)
        async function updateTask(taskId, dataToUpdate) {
            if (!state.currentUser || !taskId) return;
            const userId = state.currentUser.uid;
            const taskDocRef = doc(db, 'users', userId, 'tasks', taskId);
            try {
                await updateDoc(taskDocRef, dataToUpdate);
            } catch (error) {
                console.error("更新任務失敗:", error);
            }
        }
        
        // 刪除任務 (您可以自行添加刪除按鈕並綁定此事件)
        async function deleteTask(taskId) {
            if (!state.currentUser || !taskId) return;
            const userId = state.currentUser.uid;
            const taskDocRef = doc(db, 'users', userId, 'tasks', taskId);
            try {
                await deleteDoc(taskDocRef);
            } catch (error) {
                console.error("刪除任務失敗:", error);
            }
        }

        // =======================================================================
        // 8. 核心功能：畫面渲染 (Render) 與互動
        // =======================================================================
        
        function render() {
            taskColumnsContainer.innerHTML = ''; // 清空現有欄位

            Object.keys(STATUSES).forEach(statusKey => {
                // 創建欄位容器
                const column = document.createElement('div');
                column.id = `column-${statusKey}`;
                column.className = `p-4 rounded-lg min-h-[200px] ${STATUSES[statusKey].color}`;
                
                // 創建標題
                const title = document.createElement('h2');
                title.className = 'text-xl font-bold mb-4 text-gray-700';
                title.textContent = STATUSES[statusKey].text;
                column.appendChild(title);

                // 創建任務列表容器
                const taskList = document.createElement('div');
                taskList.id = `list-${statusKey}`;
                taskList.className = 'task-list space-y-3';
                taskList.dataset.status = statusKey;
                column.appendChild(taskList);

                // 將欄位加入主容器
                taskColumnsContainer.appendChild(column);

                // 篩選並渲染任務卡片
                const filteredTasks = state.tasks.filter(task => task.status === statusKey);
                filteredTasks.forEach(task => {
                    const taskCard = createTaskCard(task);
                    taskList.appendChild(taskCard);
                });
            });

            // 初始化所有列表的拖曳功能
            initializeSortable();
        }
        
        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = 'task-card bg-white p-3 rounded-md shadow-sm border-l-4';
            card.dataset.id = task.id;

            // 根據優先級設定邊框顏色
            if (task.priority === 3) card.classList.add('border-red-500');
            else if (task.priority === 2) card.classList.add('border-yellow-500');
            else card.classList.add('border-green-500');

            const title = document.createElement('p');
            title.className = 'font-semibold text-gray-800';
            title.textContent = task.title;
            card.appendChild(title);

            const priorityText = document.createElement('p');
            priorityText.className = 'text-sm text-gray-500 mt-1';
            priorityText.textContent = `優先級: ${PRIORITIES[task.priority] || '未定'}`;
            card.appendChild(priorityText);
            
            // 您可以在這裡加入編輯或刪除按鈕
            // const deleteBtn = document.createElement('button');
            // deleteBtn.textContent = '刪除';
            // deleteBtn.onclick = () => deleteTask(task.id);
            // card.appendChild(deleteBtn);

            return card;
        }
        
        function initializeSortable() {
            const lists = document.querySelectorAll('.task-list');
            lists.forEach(list => {
                new Sortable(list, {
                    group: 'tasks',
                    animation: 150,
                    onEnd: function (evt) {
                        const taskId = evt.item.dataset.id;
                        const newStatus = evt.to.dataset.status;
                        
                        // 尋找 state 中的任務，檢查狀態是否真的改變
                        const taskInState = state.tasks.find(t => t.id === taskId);
                        if (taskInState && taskInState.status !== newStatus) {
                            // 只有當狀態改變時才更新資料庫
                            console.log(`將任務 ${taskId} 的狀態更新為 ${newStatus}`);
                            updateTask(taskId, { status: newStatus });
                        }
                    },
                });
            });
        }
        
    </script>
</body>

</html>